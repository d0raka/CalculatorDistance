<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מחשבון מרחק</title>
    <!--
      This simple one‑page web application implements a distance‑based fee calculator.
      The design is deliberately clean and uncluttered to make it easy to use from both
      mobile and desktop devices. It uses modern CSS for layout and styling but
      requires no external dependencies. All functionality lives in a few small
      JavaScript functions at the end of this file.
    -->
    <style>
        :root {
            --bg-color: #f5f7fa;
            --primary-color: #356bb3;
            --secondary-color: #ffffff;
            --text-color: #333;
            --accent-color: #2684ff;
            --border-radius: 8px;
            --font-family: 'Segoe UI', Tahoma, sans-serif;
        }

        body {
            margin: 0;
            font-family: var(--font-family);
            background: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        header {
            width: 100%;
            background: var(--primary-color);
            color: var(--secondary-color);
            padding: 1rem 0;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
        }

        main {
            width: 100%;
            max-width: 720px;
            padding: 2rem;
            box-sizing: border-box;
        }

        .card {
            background: var(--secondary-color);
            border-radius: var(--border-radius);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }

        .form-group {
            margin-bottom: 1.2rem;
            display: flex;
            flex-direction: column;
        }

        label {
            margin-bottom: 0.3rem;
            font-weight: 600;
        }

        input[type="text"],
        input[type="number"] {
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            font-size: 1rem;
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* Remove custom direction for number inputs. Let browser handle RTL correctly.
           Hebrew readers typically expect numbers to align on the right within RTL inputs,
           and digits themselves remain left‑to‑right, so this is intuitive. */

        .radio-group {
            display: flex;
            gap: 1rem;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-weight: normal;
        }

        .actions {
            display: flex;
            gap: 0.8rem;
            margin-top: 1.5rem;
        }

        button {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: var(--border-radius);
            background: var(--primary-color);
            color: var(--secondary-color);
            cursor: pointer;
            font-size: 1rem;
        }

        button:disabled {
            background: #a0aecd;
            cursor: not-allowed;
        }

        .result-container {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: var(--border-radius);
            background: #e9f1fb;
            /* Allow multi‑line content to expand naturally */
            display: block;
            min-height: initial;
        }

        .error {
            color: #c71f1f;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <header>
        מחשבון מרחק – דור אקא
    </header>
    <main>
        <div class="card">
            <div class="form-group">
                <label for="businessName">שם בית עסק (חובה)</label>
                <input type="text" id="businessName" placeholder="הזן את שם העסק" />
            </div>
            <div class="form-group">
                <label for="orderNumber">מספר הזמנה (חובה)</label>
                <input type="number" id="orderNumber" placeholder="הזן מספר הזמנה" min="1" />
            </div>
            <div class="form-group">
                <label for="distance">מרחק במטרים (חובה)</label>
                <input type="number" id="distance" placeholder="הזן מרחק במטרים" min="1" />
            </div>
            <div class="form-group">
                <label for="bonus">בונוס אחוזים (לא חובה)</label>
                <input type="number" id="bonus" placeholder="הזן בונוס באחוזים" min="0" max="100" />
            </div>
            <div class="form-group">
                <label>בחירת כלי תחבורה (חובה)</label>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="vehicle" value="Walker">
                        הולך רגל
                    </label>
                    <label>
                        <input type="radio" name="vehicle" value="Vehicle">
                        רכב / אופנוע
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label for="gmap">קישור – חובה (Google Maps או OpenStreetMap)</label>
                <input type="text" id="gmap" placeholder="הדבק כאן את קישור ההוראות" />
            </div>
            <div class="actions">
                <button id="calcBtn" onclick="calculate()">חשב</button>
                <button id="resetBtn" onclick="resetForm()">איפוס טופס</button>
                <button id="copyBtn" onclick="copyResult()" disabled>העתק תוצאה</button>
            </div>
            <div id="result" class="result-container"></div>
        </div>
    </main>

    <script>
    /**
     * Validate map directions URL.
     *
     * Accepts both Google Maps directions URLs (e.g. https://www.google.com/maps/dir/…)
     * and OpenStreetMap directions URLs (e.g. https://www.openstreetmap.org/directions/…).
     *
     * @param {string} url The URL provided by the user.
     * @returns {boolean} True if the URL appears to be a supported directions link.
     */
    function isGMap(url) {
        // Google Maps directions pattern
        const googlePattern = /^https?:\/\/(www\.)?google\.[a-z.]+\/maps\/dir/i;
        // OpenStreetMap directions pattern
        const osmPattern = /^https?:\/\/(www\.)?openstreetmap\.org\/directions/i;
        return googlePattern.test(url) || osmPattern.test(url);
    }

    // Fee calculation for vehicle deliveries.
    function feeByDistance(m) {
        if (m <= 100) return 3;
        let fee = 3;
        const tier = len => Math.ceil(len / 100);
        const seg1 = Math.min(Math.max(m - 100, 0), 900);
        fee += tier(seg1) * 0.55;
        const seg2 = Math.min(Math.max(m - 1000, 0), 2000);
        fee += tier(seg2) * 0.35;
        const seg3 = Math.min(Math.max(m - 3000, 0), 2000);
        fee += tier(seg3) * 0.30;
        const seg4 = Math.max(m - 5000, 0);
        fee += tier(seg4) * 0.20;
        return fee;
    }

    // Fee calculation for walkers.
    function feeForWalkers(m) {
        const tiers = [
            { max: 100, price: 7 },
            { max: 150, price: 8 },
            { max: 200, price: 9 },
            { max: 250, price: 10 },
            { max: 300, price: 11 },
            { max: 350, price: 12 },
            { max: 400, price: 13 },
            { max: 450, price: 14 },
            { max: 500, price: 15 },
            { max: 550, price: 16 }
        ];
        let result = 16;
        for (const t of tiers) {
            if (m <= t.max) { result = t.price; break; }
        }
        return result;
    }

    // Calculate the additional compensation based on user input.
    function calculate() {
        const businessName = document.getElementById('businessName').value.trim();
        const orderNumber = Number(document.getElementById('orderNumber').value);
        const dist = Number(document.getElementById('distance').value);
        const bonus = Number(document.getElementById('bonus').value) || 0;
        const vehicle = document.querySelector('input[name="vehicle"]:checked')?.value;
        const link = document.getElementById('gmap').value.trim();
        const out = document.getElementById('result');

        // Reset previous messages
        out.classList.remove('error');

        // Validate input
        if (!isGMap(link)) {
            out.textContent = 'נא לוודא שהקישור הוא להוראות ב‑Google Maps או ב‑OpenStreetMap.';
            out.classList.add('error');
            document.getElementById('copyBtn').disabled = true;
            return;
        }
        if (!vehicle) {
            out.textContent = 'בחר כלי תחבורה.';
            out.classList.add('error');
            document.getElementById('copyBtn').disabled = true;
            return;
        }
        if (!businessName || !orderNumber || !dist) {
            out.textContent = 'יש למלא שם בית עסק, מספר הזמנה ומרחק.';
            out.classList.add('error');
            document.getElementById('copyBtn').disabled = true;
            return;
        }

        // Compute base fee
        const baseFee = vehicle === 'Walker' ? feeForWalkers(dist) : feeByDistance(dist);
        const rawFee = baseFee * (1 + bonus / 100);
        const finalFee = Math.ceil(rawFee);

        // Compose result message
        // Build a multi‑line summary in both HTML (for display) and plain text (for copying)
        // Insert a left‑to‑right mark before currency and digits to ensure correct display
        const feeHtml = `<span style="color:#27ae60;font-weight:bold;font-size:1.3em;">&#x200E;₪ ${finalFee}</span>`;
        // Combine business name and order number into a single line
        const htmlSummary =
            `שם בית עסק: ${businessName} | #${orderNumber}<br>` +
            `מרחק: ${dist} מטר<br>` +
            `תשלום: ${feeHtml}`;
        const plainSummary =
            `שם בית עסק: ${businessName} | #${orderNumber}\n` +
            `מרחק: ${dist} מטר\n` +
            `תשלום: ₪ ${finalFee}`;
        out.innerHTML = htmlSummary;
        out.dataset.text = plainSummary;

        // Enable copy button
        document.getElementById('copyBtn').disabled = false;

        // Log to Google Apps Script if available
        try {
            if (google && google.script && google.script.run) {
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    user: null,
                    business: businessName,
                    order: orderNumber,
                    distance: dist,
                    bonus: bonus,
                    vehicle: vehicle,
                    fee: finalFee,
                    gmap: link
                };
                google.script.run.logCalculation(logEntry);
            }
        } catch (err) {
            // Ignore logging errors; this site may not run within a Google Apps Script context.
        }
    }

    // Copy the result text to the clipboard.
    function copyResult() {
        const el = document.getElementById('result');
        // Prefer the plain text summary stored in data attribute; fall back to textContent
        const txt = (el.dataset.text || el.textContent).trim();
        if (!txt) return;
        navigator.clipboard.writeText(txt).then(() => {
            const btn = document.getElementById('copyBtn');
            const old = btn.textContent;
            btn.textContent = '✓ הועתק!';
            setTimeout(() => btn.textContent = old, 1500);
        }).catch(() => {
            alert('לא ניתן להעתיק לטלפון זה.');
        });
    }

    // Reset the form and clear results.
    function resetForm() {
        document.getElementById('orderNumber').value = '';
        document.getElementById('businessName').value = '';
        document.querySelectorAll('input[name="vehicle"]').forEach(r => r.checked = false);
        document.getElementById('distance').value = '';
        document.getElementById('bonus').value = '';
        document.getElementById('gmap').value = '';
        document.getElementById('result').textContent = '';
        document.getElementById('result').classList.remove('error');
        document.getElementById('copyBtn').disabled = true;
    }
    </script>
</body>
</html>
